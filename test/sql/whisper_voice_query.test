# name: test/sql/whisper_voice_query.test
# description: Tests for voice-to-SQL feature
# group: [sql]

require whisper

# Test configuration using SET statements

# Test setting and getting whisper_text_to_sql_url
statement ok
SET whisper_text_to_sql_url = 'http://localhost:4000/generate-sql';

query I
SELECT whisper_get_text_to_sql_url();
----
http://localhost:4000/generate-sql

# Test setting and getting whisper_text_to_sql_timeout
statement ok
SET whisper_text_to_sql_timeout = 60;

query I
SELECT whisper_get_text_to_sql_timeout();
----
60

# Test setting and getting whisper_voice_query_show_sql
statement ok
SET whisper_voice_query_show_sql = true;

query I
SELECT whisper_get_voice_query_show_sql();
----
true

# Test device_id setting

# Default device_id should be -1
query I
SELECT whisper_get_device_id();
----
-1

# Set device_id to 0
statement ok
SET whisper_device_id = 0;

# Verify device_id was set
query I
SELECT whisper_get_device_id();
----
0

# Reset to default (-1)
statement ok
RESET whisper_device_id;

# Verify device_id was reset
query I
SELECT whisper_get_device_id();
----
-1

# Test whisper_get_config includes device_id
query I
SELECT whisper_get_config() LIKE '%device_id=%';
----
true

# Test recording config settings

# Test max_duration (default should be 15)
query I
SELECT whisper_get_max_duration();
----
15.0

statement ok
SET whisper_max_duration = 30;

query I
SELECT whisper_get_max_duration();
----
30.0

# Test silence_duration (default should be 1)
query I
SELECT whisper_get_silence_duration();
----
1.0

statement ok
SET whisper_silence_duration = 2;

query I
SELECT whisper_get_silence_duration();
----
2.0

# Test silence_threshold (default should be 0.001)
query I
SELECT whisper_get_silence_threshold();
----
0.001

statement ok
SET whisper_silence_threshold = 0.005;

query I
SELECT whisper_get_silence_threshold();
----
0.005

# Test whisper_get_config includes recording settings
query I
SELECT whisper_get_config() LIKE '%max_duration=%';
----
true

query I
SELECT whisper_get_config() LIKE '%silence_duration=%';
----
true

query I
SELECT whisper_get_config() LIKE '%silence_threshold=%';
----
true

# Test whisper_get_config includes voice query settings
query I
SELECT whisper_get_config() LIKE '%text_to_sql_url=%';
----
true

query I
SELECT whisper_get_config() LIKE '%text_to_sql_timeout=%';
----
true

query I
SELECT whisper_get_config() LIKE '%voice_query_show_sql=%';
----
true

# Test that settings are visible in duckdb_settings()
query I
SELECT count(*) > 0 FROM duckdb_settings() WHERE name LIKE 'whisper_%';
----
true

# Test current_setting() alternative to getter functions
statement ok
SET whisper_device_id = 5;

query I
SELECT current_setting('whisper_device_id');
----
5

# Test that voice query functions exist by checking error messages
# (can't test full functionality without proxy, microphone, and model)

# Note: We don't test the actual recording functions here because:
# 1. They require a microphone
# 2. They require a whisper model to be downloaded
# 3. They would block waiting for input
# Instead, we verify the functions are registered by checking other behaviors

# Test DDL extraction works (this doesn't require microphone or proxy)
# Create a test table and verify it's accessible

statement ok
CREATE TABLE test_voice_query (id INTEGER, name VARCHAR);

statement ok
INSERT INTO test_voice_query VALUES (1, 'Alice'), (2, 'Bob');

# Verify the table was created and can be queried
query II
SELECT * FROM test_voice_query ORDER BY id;
----
1	Alice
2	Bob

# Clean up
statement ok
DROP TABLE test_voice_query;
